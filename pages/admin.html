<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>WalletHunter ‚Äî Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../css/main.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { font-size: 13px; padding-bottom: 60px; }
    .wrap { max-width: 900px; margin: 0 auto; }
    .card { border: 1px solid #00ff99; border-radius: 10px; padding: 8px; margin: 8px 0; text-align:left; }
    .title { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
    .muted { opacity: .7; font-size: 12px; }
    .row { display:flex; gap: 6px; flex-wrap: wrap; align-items:center; }
    input {
      padding: 4px 6px; border-radius: 6px;
      border: 1px solid rgba(0,255,153,.6);
      background:#0b0b0b; color:#00ff99;
      font-size: 12px; width: 90px; outline:none;
    }
    table { width:100%; border-collapse: collapse; font-size:12px; }
    th, td { padding: 4px 6px; border-bottom: 1px dashed rgba(0,255,153,.25); vertical-align: top; }
    th { font-weight:700; white-space:nowrap; }
    .btnSm { padding: 4px 8px; font-size: 12px; }
    .danger { border-color:#ff6b6b; color:#ff6b6b; }
    .navBar {
      position: fixed; left:0; right:0; bottom:0;
      padding: 6px; background: rgba(11,11,11,.95);
      border-top: 1px solid #00ff99;
      display:flex; justify-content:center; gap:10px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <h2>üîß Admin Panel</h2>

  <div id="denied" class="card" style="display:none;">
    <div class="title">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</div>
    <div class="muted">–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –ø–æ Telegram ID + –ø–∞—Ä–æ–ª—å.</div>
    <div style="margin-top:10px;">
      <button onclick="location.href='dashboard.html'">–ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <div id="login" class="card" style="display:none;">
    <div class="title">–í—Ö–æ–¥</div>
    <div class="muted">–ü–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–ø–æ–∫–∞ MVP).</div>
    <div class="row" style="margin-top:10px;">
      <input id="pwd" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
      <button class="btnSm" id="btnLogin">–í–æ–π—Ç–∏</button>
      <button class="btnSm danger" id="btnSetPwd">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/—Å–º–µ–Ω–∏—Ç—å</button>
    </div>
    <div class="muted" style="margin-top:8px;" id="pwdHint">‚Äî</div>
  </div>

  <div id="panel" style="display:none;">
    <div class="card">
      <div class="title">üåê API</div>
      <div class="muted">–ê–¥–º–∏–Ω–∫–∞ —á–∏—Ç–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ SQLite —á–µ—Ä–µ–∑ API.</div>
      <div class="row" style="margin-top:8px;">
        <input id="apiBase" placeholder="API_BASE" />
        <input id="apiKey" placeholder="X-API-Key" />
        <button class="btnSm" id="btnSaveApi">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btnSm" id="btnTestApi">–¢–µ—Å—Ç /health</button>
      </div>
      <div class="muted" style="margin-top:6px;" id="apiStatus">‚Äî</div>
    </div>

    <div class="card">
      <div class="title">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
      <div class="muted">–°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–∏—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞. –ö–Ω–æ–ø–∫–∞ ‚Äú–°–æ—Ö—Ä–∞–Ω–∏—Ç—å‚Äù –ø–æ–∫–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è (—Å–ª–µ–¥–æ–º —Å–¥–µ–ª–∞–µ–º –∑–∞–ø–∏—Å—å –≤ SQLite).</div>
      <div class="row" style="margin-top:10px;">
        <button class="btnSm" id="btnRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:180px;">User</th>
            <th style="width:110px;">Win %</th>
            <th style="width:100px;">Gen</th>
            <th>Balances</th>
            <th style="width:120px;">Actions</th>
          </tr>
        </thead>
        <tbody id="usersTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="navBar">
  <button onclick="location.href='dashboard.html'">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
</div>

<script>
  // ====== –í–ü–ò–®–ò –°–í–û–ô Telegram ID (—á–∏—Å–ª–æ–º) ======
  const ADMIN_ID = 0;

  // ====== LOCAL STORAGE KEYS ======
  const ADMIN_PWD_KEY = "wh_admin_password";
  const API_BASE_KEY = "wh_api_base";
  const API_KEY_KEY = "wh_api_key";
  const USERS_LOCAL_KEY = "wh_users"; // –ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ "—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å"

  const tg = window.Telegram?.WebApp;
  tg?.ready?.();

  function getTgUser() {
    const u = tg?.initDataUnsafe?.user;
    if (u && u.id) return u;
    try { return JSON.parse(localStorage.getItem("tg_user") || "null") || { id: 0 }; } catch { return { id: 0 }; }
  }

  function getPwd() { return (localStorage.getItem(ADMIN_PWD_KEY) || "").trim(); }
  function setPwd(p) { localStorage.setItem(ADMIN_PWD_KEY, String(p||"").trim()); }

  function getApiBase() { return (localStorage.getItem(API_BASE_KEY) || "").trim(); }
  function setApiBase(v) { localStorage.setItem(API_BASE_KEY, String(v||"").trim()); }

  function getApiKey() { return (localStorage.getItem(API_KEY_KEY) || "").trim(); }
  function setApiKey(v) { localStorage.setItem(API_KEY_KEY, String(v||"").trim()); }

  function loadUsersLocal() {
    try { return JSON.parse(localStorage.getItem(USERS_LOCAL_KEY) || "{}"); } catch { return {}; }
  }
  function saveUsersLocal(obj) {
    localStorage.setItem(USERS_LOCAL_KEY, JSON.stringify(obj));
  }

  const deniedEl = document.getElementById("denied");
  const loginEl = document.getElementById("login");
  const panelEl = document.getElementById("panel");

  const me = getTgUser();
  const isAdminById = (Number(me?.id || 0) === Number(ADMIN_ID)) && ADMIN_ID !== 0;

  function showDenied(){ deniedEl.style.display="block"; loginEl.style.display="none"; panelEl.style.display="none"; }
  function showLogin(){
    deniedEl.style.display="none"; loginEl.style.display="block"; panelEl.style.display="none";
    document.getElementById("pwdHint").textContent = getPwd() ? "–ü–∞—Ä–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω." : "–ü–∞—Ä–æ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî –Ω–∞–∂–º–∏ ¬´–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/—Å–º–µ–Ω–∏—Ç—å¬ª.";
  }
  function showPanel(){ deniedEl.style.display="none"; loginEl.style.display="none"; panelEl.style.display="block"; initApiUI(); refreshUsers(); }

  if (!isAdminById) showDenied(); else showLogin();

  document.getElementById("btnLogin").onclick = () => {
    const entered = (document.getElementById("pwd").value || "").trim();
    const cur = getPwd();
    if (!cur) return alert("–ü–∞—Ä–æ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.");
    if (entered !== cur) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.");
    showPanel();
  };

  document.getElementById("btnSetPwd").onclick = () => {
    const entered = (document.getElementById("pwd").value || "").trim();
    if (entered.length < 4) return alert("–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞.");
    setPwd(entered);
    alert("–ü–∞—Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω.");
    showPanel();
  };

  // ====== API UI ======
  function initApiUI() {
    const base = getApiBase();
    const key = getApiKey();
    document.getElementById("apiBase").value = base;
    document.getElementById("apiKey").value = key;
    document.getElementById("apiStatus").textContent = base ? "API_BASE —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω." : "API_BASE –ø—É—Å—Ç–æ–π (–≤—Å—Ç–∞–≤—å ngrok url).";
  }

  document.getElementById("btnSaveApi").onclick = () => {
    const base = (document.getElementById("apiBase").value || "").trim().replace(/\/+$/,'');
    const key = (document.getElementById("apiKey").value || "").trim();
    setApiBase(base);
    setApiKey(key);
    document.getElementById("apiStatus").textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.";
  };

  document.getElementById("btnTestApi").onclick = async () => {
    const base = (document.getElementById("apiBase").value || "").trim().replace(/\/+$/,'');
    if (!base) return alert("–í—Å—Ç–∞–≤—å API_BASE");
    try {
      const r = await fetch(base + "/health");
      const j = await r.json();
      document.getElementById("apiStatus").textContent = "health: " + JSON.stringify(j);
    } catch (e) {
      document.getElementById("apiStatus").textContent = "–û—à–∏–±–∫–∞ /health: " + String(e);
    }
  };

  document.getElementById("btnRefresh").onclick = () => refreshUsers();

  async function fetchUsersFromServer() {
    const base = getApiBase();
    const key = getApiKey();
    if (!base) throw new Error("API_BASE –ø—É—Å—Ç–æ–π");
    if (!key) throw new Error("X-API-Key –ø—É—Å—Ç–æ–π");

    const res = await fetch(base.replace(/\/+$/,'') + "/admin/users", {
      headers: { "X-API-Key": key }
    });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    if (!data || !data.ok) throw new Error("bad response");
    return data.users || [];
  }

  async function refreshUsers() {
    const tb = document.getElementById("usersTbody");
    tb.innerHTML = `<tr><td colspan="5" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>`;

    try {
      const users = await fetchUsersFromServer();
      renderUsers(users);
      document.getElementById("apiStatus").textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`;
    } catch (e) {
      tb.innerHTML = `<tr><td colspan="5" class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${String(e)}</td></tr>`;
      document.getElementById("apiStatus").textContent = `–û—à–∏–±–∫–∞: ${String(e)}`;
    }
  }

  function fmtLastSeen(ts) {
    if (!ts) return "-";
    try {
      const d = new Date(ts * 1000);
      return d.toLocaleString();
    } catch { return String(ts); }
  }

  function renderUsers(users) {
    const tb = document.getElementById("usersTbody");
    tb.innerHTML = "";

    // –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
    const local = loadUsersLocal();

    for (const u of users) {
      const id = String(u.user_id);
      const uname = u.username ? "@"+u.username : ((u.first_name||"") + " " + (u.last_name||"")).trim() || "‚Äî";

      // –µ—Å–ª–∏ –≤ local –µ—Å—Ç—å –∑–∞–ø–∏—Å—å ‚Äî –ø–æ–∫–∞–∂–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
      const win = Number((local[id]?.win_chance ?? u.win_chance ?? 1.0));
      const gen = Number((local[id]?.generator_level ?? u.gen_level ?? 0));
      const mm = Number((local[id]?.bal_mmcoin ?? u.bal_mmc ?? 0));
      const ton = Number((local[id]?.bal_ton ?? u.bal_ton ?? 0));
      const usdt = Number((local[id]?.bal_usdt ?? u.bal_usdt ?? 0));
      const stars = Number((local[id]?.bal_stars ?? u.bal_stars ?? 0));

      // –æ–±–µ—Å–ø–µ—á–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É local –¥–ª—è save
      if (!local[id]) {
        local[id] = {
          id: u.user_id,
          username: u.username || "",
          name: uname,
          last_seen: Date.now(),
          win_chance: win,
          generator_level: gen,
          bal_mmcoin: mm,
          bal_ton: ton,
          bal_usdt: usdt,
          bal_stars: stars
        };
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div><b>${uname}</b></div>
          <div class="muted">ID: ${u.user_id}</div>
          <div class="muted">last: ${fmtLastSeen(u.last_seen)}</div>
        </td>

        <td><input type="number" step="0.1" min="0" value="${win.toFixed(1)}" data-id="${id}" data-k="win_chance"></td>
        <td><input type="number" step="1" min="0" value="${gen}" data-id="${id}" data-k="generator_level"></td>

        <td>
          <div>MMM <input type="number" step="1" value="${mm}" data-id="${id}" data-k="bal_mmcoin"></div>
          <div>TON <input type="number" step="0.01" value="${ton}" data-id="${id}" data-k="bal_ton"></div>
          <div>USDT <input type="number" step="0.01" value="${usdt}" data-id="${id}" data-k="bal_usdt"></div>
          <div>‚≠ê <input type="number" step="1" value="${stars}" data-id="${id}" data-k="bal_stars"></div>
        </td>

        <td>
          <button class="btnSm" data-act="save" data-id="${id}">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </td>
      `;
      tb.appendChild(tr);
    }

    saveUsersLocal(local);

    tb.onclick = (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      if (btn.getAttribute("data-act") !== "save") return;
      saveRowLocal(btn.getAttribute("data-id"));
    };
  }

  function saveRowLocal(id) {
    const local = loadUsersLocal();
    if (!local[id]) return;

    const inputs = document.querySelectorAll(`input[data-id="${id}"]`);
    for (const inp of inputs) {
      const k = inp.getAttribute("data-k");
      const v = Number(inp.value);
      if (!k || Number.isNaN(v)) continue;
      local[id][k] = v;
    }

    saveUsersLocal(local);
    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ. –°–ª–µ–¥–æ–º –ø–æ–¥–∫–ª—é—á–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ SQLite —á–µ—Ä–µ–∑ API.");
  }
</script>
</body>
</html>
