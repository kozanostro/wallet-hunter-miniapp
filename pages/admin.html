<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>WalletHunter ‚Äî Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../css/main.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    .wrap{max-width:1100px;margin:0 auto;}
    .card{border:1px solid #00ff99;border-radius:12px;padding:12px;text-align:left;margin:12px 0;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .muted{opacity:.75}
    .title{font-size:18px;font-weight:800;margin:0 0 6px 0;}
    input, select{
      padding:10px;border-radius:10px;border:1px solid rgba(0,255,153,.6);
      background:#0b0b0b;color:#00ff99;outline:none;
    }
    input{min-width:180px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th, td{border-bottom:1px dashed rgba(0,255,153,.25);padding:8px;text-align:left;vertical-align:top;}
    th{font-weight:800;}
    .btnSm{padding:10px 14px}
    .danger{border-color:#ff6b6b;color:#ff6b6b}
    .ok{color:#00ff99}
    .navBar{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px;background:rgba(11,11,11,.95);
      border-top:1px solid #00ff99;
      display:flex;gap:10px;justify-content:center;flex-wrap:wrap;
    }
    body{padding-bottom:90px;}
    .pill{padding:2px 8px;border:1px solid #00ff99;border-radius:999px;font-size:12px;}
  </style>
</head>

<body>
<div class="wrap">
  <h2>üîß Admin Panel</h2>

  <div id="denied" class="card" style="display:none;">
    <div class="title">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</div>
    <div class="muted">
      –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (–ø–æ Telegram ID) + –ø–∞—Ä–æ–ª—å.
    </div>
    <div style="margin-top:10px;">
      <button onclick="location.href='dashboard.html'">–ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <div id="login" class="card" style="display:none;">
    <div class="title">–í—Ö–æ–¥ (–ø–∞—Ä–æ–ª—å)</div>
    <div class="muted">–ü–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ/Telegram WebView (–ø–æ–∫–∞ MVP).</div>

    <div class="row" style="margin-top:10px;">
      <input id="pwd" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
      <button class="btnSm" id="btnLogin">–í–æ–π—Ç–∏</button>
      <button class="btnSm danger" id="btnSetPwd">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/—Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
    </div>

    <div class="muted" style="margin-top:8px;" id="pwdHint">‚Äî</div>
  </div>

  <div id="panel" style="display:none;">
    <div class="card">
      <div class="title">‚öôÔ∏è –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ç–∞–π–º–∏–Ω–≥–∏ Hunt</div>
      <div class="muted">–≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤–ª–∏—è—é—Ç –Ω–∞ —Ç–µ–∫—É—â–∏–π `hunt.js` (–≥–ª–æ–±–∞–ª—å–Ω–æ).</div>

      <div class="row" style="margin-top:10px;">
        <label class="muted">–ü–æ–∏—Å–∫ –∫–æ—à–µ–ª—å–∫–∞ (—Å–µ–∫):</label>
        <input id="globWalletSec" type="number" min="1" value="30" />
        <label class="muted">–°–∏–¥-—Ñ—Ä–∞–∑—ã (—Å–µ–∫):</label>
        <input id="globSeedSec" type="number" min="1" value="20" />
        <button class="btnSm" id="btnSaveGlobal">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        (–ü–æ–∑–∂–µ —Å–¥–µ–ª–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –Ω–æ MVP —É–∂–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è.)
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="title">üë• –†–µ–µ—Å—Ç—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
          <div class="muted">–ú–æ–∂–Ω–æ –ø—Ä–∞–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã, % –≤—ã–∏–≥—Ä—ã—à–∞, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä.</div>
        </div>
        <div class="row">
          <span class="pill">users: <b id="usersCount">0</b></span>
          <button class="btnSm" id="btnRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="btnSm danger" id="btnWipeFeed">–û—á–∏—Å—Ç–∏—Ç—å –ª–µ–Ω—Ç—É</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:170px;">User</th>
            <th style="width:120px;">Win %</th>
            <th style="width:120px;">Gen lvl</th>
            <th>Balances</th>
            <th style="width:180px;">Time/Meta</th>
            <th style="width:160px;">Actions</th>
          </tr>
        </thead>
        <tbody id="usersTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="navBar">
  <button onclick="location.href='dashboard.html'">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
</div>

<script>
  // ========= –ù–ê–°–¢–†–û–ô–ö–ò =========
  // –í–ê–ñ–ù–û: –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å dashboard.html
  const ADMIN_ID = 1901263391; // <-- –í–ü–ò–®–ò –°–í–û–ô Telegram ID

  // ========= STORAGE =========
  const USERS_KEY = "wh_users";
  const ADMIN_PWD_KEY = "wh_admin_password";
  const FEED_KEY = "wh_feed";

  const GLOBAL_WALLET_MS_KEY = "hunt_wallet_duration_ms";
  const GLOBAL_SEED_MS_KEY = "hunt_seed_duration_ms";

  const tg = window.Telegram?.WebApp;
  tg?.ready?.();

  function getTgUser() {
    const u = tg?.initDataUnsafe?.user;
    if (u && u.id) return u;
    try { return JSON.parse(localStorage.getItem("tg_user") || "null") || { id: 0 }; } catch { return { id: 0 }; }
  }

  function loadUsers() {
    try { return JSON.parse(localStorage.getItem(USERS_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveUsers(obj) {
    localStorage.setItem(USERS_KEY, JSON.stringify(obj));
  }

  function getAdminPwd() {
    return (localStorage.getItem(ADMIN_PWD_KEY) || "").trim();
  }
  function setAdminPwd(p) {
    localStorage.setItem(ADMIN_PWD_KEY, String(p || "").trim());
  }

  function addFeed(msg) {
    let feed = [];
    try { feed = JSON.parse(localStorage.getItem(FEED_KEY) || "[]"); } catch {}
    feed.unshift(msg);
    feed = feed.slice(0, 30);
    localStorage.setItem(FEED_KEY, JSON.stringify(feed));
  }

  // ========= AUTH =========
  const tgUser = getTgUser();
  const isAdminById = (Number(tgUser?.id || 0) === Number(ADMIN_ID)) && ADMIN_ID !== 0;

  const deniedEl = document.getElementById("denied");
  const loginEl = document.getElementById("login");
  const panelEl = document.getElementById("panel");

  function showDenied() {
    deniedEl.style.display = "block";
    loginEl.style.display = "none";
    panelEl.style.display = "none";
  }

  function showLogin() {
    deniedEl.style.display = "none";
    loginEl.style.display = "block";
    panelEl.style.display = "none";

    const hint = document.getElementById("pwdHint");
    const cur = getAdminPwd();
    hint.textContent = cur ? "–ü–∞—Ä–æ–ª—å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω." : "–ü–∞—Ä–æ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî –Ω–∞–∂–º–∏ ¬´–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/—Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å¬ª.";
  }

  function showPanel() {
    deniedEl.style.display = "none";
    loginEl.style.display = "none";
    panelEl.style.display = "block";
    loadGlobalTimersToUI();
    renderUsersTable();
  }

  if (!isAdminById) {
    showDenied();
  } else {
    showLogin();
  }

  // ========= LOGIN ACTIONS =========
  document.getElementById("btnLogin").onclick = () => {
    const entered = (document.getElementById("pwd").value || "").trim();
    const cur = getAdminPwd();
    if (!cur) {
      alert("–ü–∞—Ä–æ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ù–∞–∂–º–∏ ¬´–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/—Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å¬ª.");
      return;
    }
    if (entered !== cur) {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.");
      return;
    }
    showPanel();
  };

  document.getElementById("btnSetPwd").onclick = () => {
    const entered = (document.getElementById("pwd").value || "").trim();
    if (entered.length < 4) {
      alert("–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞.");
      return;
    }
    setAdminPwd(entered);
    alert("–ü–∞—Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω.");
    showPanel();
  };

  // ========= GLOBAL TIMERS =========
  function loadGlobalTimersToUI() {
    const wMs = Number(localStorage.getItem(GLOBAL_WALLET_MS_KEY) || 30000);
    const sMs = Number(localStorage.getItem(GLOBAL_SEED_MS_KEY) || 20000);
    document.getElementById("globWalletSec").value = String(Math.max(1, Math.round(wMs / 1000)));
    document.getElementById("globSeedSec").value = String(Math.max(1, Math.round(sMs / 1000)));
  }

  document.getElementById("btnSaveGlobal").onclick = () => {
    const wSec = Number(document.getElementById("globWalletSec").value || 30);
    const sSec = Number(document.getElementById("globSeedSec").value || 20);
    localStorage.setItem(GLOBAL_WALLET_MS_KEY, String(Math.max(1, wSec) * 1000));
    localStorage.setItem(GLOBAL_SEED_MS_KEY, String(Math.max(1, sSec) * 1000));
    addFeed(`–ê–¥–º–∏–Ω: –æ–±–Ω–æ–≤–∏–ª —Ç–∞–π–º–∏–Ω–≥–∏ Hunt (wallet=${wSec}s, seed=${sSec}s)`);
    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.");
  };

  // ========= USERS TABLE =========
  document.getElementById("btnRefresh").onclick = () => renderUsersTable();

  document.getElementById("btnWipeFeed").onclick = () => {
    localStorage.setItem(FEED_KEY, JSON.stringify([]));
    alert("–õ–µ–Ω—Ç–∞ –æ—á–∏—â–µ–Ω–∞.");
  };

  function renderUsersTable() {
    const users = loadUsers();
    const ids = Object.keys(users);
    document.getElementById("usersCount").textContent = String(ids.length);

    const tb = document.getElementById("usersTbody");
    tb.innerHTML = "";

    ids.sort((a,b) => (users[b].last_seen||0) - (users[a].last_seen||0));

    for (const id of ids) {
      const u = users[id];

      const tr = document.createElement("tr");

      const userCell = document.createElement("td");
      userCell.innerHTML = `
        <div><b>${u.username ? "@"+u.username : (u.name || "user")}</b></div>
        <div class="muted">ID: ${u.id}</div>
      `;
      tr.appendChild(userCell);

      const winCell = document.createElement("td");
      winCell.innerHTML = `<input type="number" step="0.1" min="0" value="${Number(u.win_chance || 1.0).toFixed(1)}" data-k="win_chance" data-id="${id}">`;
      tr.appendChild(winCell);

      const genCell = document.createElement("td");
      genCell.innerHTML = `<input type="number" step="1" min="0" value="${Number(u.generator_level || 0)}" data-k="generator_level" data-id="${id}">`;
      tr.appendChild(genCell);

      const balCell = document.createElement("td");
      balCell.innerHTML = `
        <div class="row">
          <label class="muted">3MC:</label><input type="number" step="1" value="${Number(u.bal_mmcoin||0)}" data-k="bal_mmcoin" data-id="${id}">
          <label class="muted">TON:</label><input type="number" step="0.01" value="${Number(u.bal_ton||0)}" data-k="bal_ton" data-id="${id}">
          <label class="muted">USDT:</label><input type="number" step="0.01" value="${Number(u.bal_usdt||0)}" data-k="bal_usdt" data-id="${id}">
          <label class="muted">Stars:</label><input type="number" step="1" value="${Number(u.bal_stars||0)}" data-k="bal_stars" data-id="${id}">
        </div>
      `;
      tr.appendChild(balCell);

      const metaCell = document.createElement("td");
      const mins = Math.floor(Number(u.total_active_ms||0)/60000);
      metaCell.innerHTML = `
        <div class="muted">–í—Ä–µ–º—è: <b class="ok">${mins}</b> –º–∏–Ω</div>
        <div class="muted">–ó–∞–ø—É—Å–∫–∏: <b>${u.launches||0}</b></div>
      `;
      tr.appendChild(metaCell);

      const actCell = document.createElement("td");
      actCell.innerHTML = `
        <div class="row">
          <button class="btnSm" data-act="save" data-id="${id}">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btnSm danger" data-act="resetHunt" data-id="${id}">–°–±—Ä–æ—Å Hunt</button>
        </div>
      `;
      tr.appendChild(actCell);

      tb.appendChild(tr);
    }

    // –¥–µ–ª–µ–≥–∏—Ä—É–µ–º –∫–ª–∏–∫–∏
    tb.onclick = (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");
      if (!id) return;

      if (act === "save") {
        saveUserRow(id);
      } else if (act === "resetHunt") {
        resetHuntForUser(id);
      }
    };
  }

  function saveUserRow(id) {
    const users = loadUsers();
    if (!users[id]) return;

    // —á–∏—Ç–∞–µ–º –≤—Å–µ input –ø–æ —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const inputs = document.querySelectorAll(`input[data-id="${id}"]`);
    for (const inp of inputs) {
      const k = inp.getAttribute("data-k");
      if (!k) continue;
      const val = Number(inp.value);
      users[id][k] = isNaN(val) ? users[id][k] : val;
    }

    saveUsers(users);

    const u = users[id];
    addFeed(`–ê–¥–º–∏–Ω: –æ–±–Ω–æ–≤–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${u.username ? "@"+u.username : u.id} (win=${Number(u.win_chance||0).toFixed(1)}%, gen=${u.generator_level||0})`);
    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.");
  }

  function resetHuntForUser(id) {
    // –í —Ç–µ–∫—É—â–µ–º MVP hunt —Ö—Ä–∞–Ω–∏—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ localStorage.
    // –ü–æ—ç—Ç–æ–º—É "—Å–±—Ä–æ—Å" ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π. –ü–æ–∑–∂–µ —Å–¥–µ–ª–∞–µ–º –ø–µ—Ä-—é–∑–µ—Ä –∫–ª—é—á–∏.
    localStorage.removeItem("hunt_phase");
    localStorage.removeItem("hunt_wallet_endAt");
    localStorage.removeItem("hunt_seed_endAt");
    localStorage.removeItem("hunt_fake_addr");
    localStorage.removeItem("hunt_fake_seed");
    localStorage.removeItem("hunt_reward");
    addFeed(`–ê–¥–º–∏–Ω: —Å–±—Ä–æ—Å–∏–ª Hunt —Ü–∏–∫–ª (–≥–ª–æ–±–∞–ª—å–Ω–æ)`);
    alert("Hunt —Å–±—Ä–æ—à–µ–Ω (–≥–ª–æ–±–∞–ª—å–Ω–æ).");
  }
</script>
</body>
</html>

