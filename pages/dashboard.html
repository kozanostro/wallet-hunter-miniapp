<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>WalletHunter ‚Äî –ö–∞–±–∏–Ω–µ—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../css/main.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    .wrap{max-width:980px;margin:0 auto;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .card{border:1px solid #00ff99;border-radius:12px;padding:12px;text-align:left;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .muted{opacity:.75}
    .title{font-size:18px;font-weight:800;margin:0 0 6px 0;}
    .kv{display:flex;justify-content:space-between;border-bottom:1px dashed rgba(0,255,153,.25);padding:6px 0;}
    .kv:last-child{border-bottom:none;}
    .pill{padding:2px 8px;border:1px solid #00ff99;border-radius:999px;font-size:12px;}
    .btnWide{min-width:220px}

    .ok{color:#00ff99}
    .bad{color:#ff6b6b;border-color:#ff6b6b}

    .navBar{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px;background:rgba(11,11,11,.95);
      border-top:1px solid #00ff99;
      display:flex;gap:10px;justify-content:center;flex-wrap:wrap;
    }
    body{padding-bottom:90px;}

    /* –ë–ï–ì–£–©–ê–Ø –°–¢–†–û–ö–ê */
    .ticker {
      white-space: nowrap;
      overflow: hidden;
      position: relative;
    }
    #tickerContent {
      display: inline-block;
      padding-left: 100%;
      animation: tickerMove 18s linear infinite;
    }
    @keyframes tickerMove {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    /* –≠–ú–ò–°–°–ò–Ø */
    .progressWrap {
      width: 100%;
      height: 14px;
      background: rgba(0,255,153,0.15);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progressBar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00ff99, #00ccff);
      transition: width 0.6s ease;
    }

    /* ADMIN button */
    .adminBtn{border-color:#ffd166;color:#ffd166}
  </style>
</head>

<body>
<div class="wrap">
  <h2>üë§ –ö–∞–±–∏–Ω–µ—Ç</h2>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="title" id="uTitle">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
        <div class="muted" id="uSub">‚Äî</div>
      </div>

      <div class="row">
        <span class="pill" id="walletStatus">–ö–æ—à–µ–ª—ë–∫: ?</span>
        <button id="adminBtn" class="adminBtn" style="display:none;" onclick="location.href='admin.html'">
          üîß ADMIN
        </button>
      </div>
    </div>
  </div>

  <!-- –ë–µ–≥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞ (–≤–µ—Ä–Ω—É–ª–∏) -->
  <div class="card" style="margin-top:12px; overflow:hidden;">
    <div class="ticker">
      <div id="tickerContent">üîî –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>
    </div>
  </div>

  <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å + –ë–∞–ª–∞–Ω—Å—ã -->
  <div class="grid2" style="margin-top:12px;">
    <div class="card">
      <div class="title">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å</div>
      <div class="kv"><span class="muted">–í—Ä–µ–º—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</span><span><b id="timeMin">0</b> –º–∏–Ω</span></div>
      <div class="kv"><span class="muted">–ó–∞–ø—É—Å–∫–æ–≤</span><span><b id="launches">1</b></span></div>
      <div class="kv"><span class="muted">–®–∞–Ω—Å –≤—ã–∏–≥—Ä—ã—à–∞</span><span><b id="winChance">1.0</b>%</span></div>
      <div class="kv"><span class="muted">–£—Ä–æ–≤–µ–Ω—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞</span><span><b id="genLevel">0</b></span></div>
    </div>

    <div class="card">
      <div class="title">üí∞ –ë–∞–ª–∞–Ω—Å—ã</div>
      <div class="kv"><span class="muted">MMMcoin</span><span><b id="mmcoin">0</b></span></div>
      <div class="kv"><span class="muted">TON</span><span><b id="ton">0</b></span></div>
      <div class="kv"><span class="muted">USDT</span><span><b id="usdt">0</b></span></div>
      <div class="kv"><span class="muted">Stars</span><span><b id="stars">0</b></span></div>
    </div>
  </div>

  <!-- –í–ò–ó–£–ê–õ–¨–ù–ê–Ø –≠–ú–ò–°–°–ò–Ø (30000000.000) -->
  <div class="card" style="margin-top:12px;">
    <div class="title">üìà –≠–º–∏—Å—Å–∏—è MMMcoin</div>

    <div class="kv">
      <span class="muted">–í—Å–µ–≥–æ</span>
      <span><b id="mmmTotal">30 000 000.000</b></span>
    </div>

    <div class="kv">
      <span class="muted">–í –æ–±—Ä–∞—â–µ–Ω–∏–∏</span>
      <span><b id="mmmUsed">0.000</b></span>
    </div>

    <div class="kv">
      <span class="muted">–û—Å—Ç–∞–ª–æ—Å—å</span>
      <span><b id="mmmLeft">30 000 000.000</b></span>
    </div>

    <div class="progressWrap">
      <div id="mmmBar" class="progressBar"></div>
    </div>

    <div class="muted" style="margin-top:8px;">
      –°–µ–π—á–∞—Å ‚Äú–≤ –æ–±—Ä–∞—â–µ–Ω–∏–∏‚Äù —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ —Å—É–º–º–∞ MMMcoin –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º 
    </div>
  </div>

  <!-- –ú–µ–Ω—é -->
  <div class="card" style="margin-top:12px;">
    <div class="title">üéÆ –ú–µ–Ω—é</div>
    <div class="row">
      <button class="btnWide" onclick="location.href='hunt.html'">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å</button>
      <button class="btnWide" onclick="location.href='mmcoin.html'">üí† MMMcoin</button>
      <button class="btnWide" onclick="location.href='leaderboard.html'">üèÜ –¢–æ–ø</button>
    </div>
    <div class="muted" style="margin-top:8px;">
      –†–µ–∞–ª—å–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏/–≤—ã–ø–ª–∞—Ç—ã –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ. –°–µ–π—á–∞—Å MVP + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.
    </div>
  </div>
</div>

<div class="navBar">
  <button onclick="location.href='dashboard.html'">–í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é</button>
  <button onclick="location.href='dashboard.html'">–í–æ–∑–≤—Ä–∞—Ç –≤ –∫–æ—à–µ–ª—ë–∫</button>
</div>

<script>
  // ================== –ù–ê–°–¢–†–û–ô–ö–ò ==================
  // –í–ü–ò–®–ò –°–í–û–ô Telegram ID (—á–∏—Å–ª–æ), —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∫–Ω–æ–ø–∫—É ADMIN
  const ADMIN_ID = 1901263391;

  // ================== TELEGRAM ==================
  const tg = window.Telegram?.WebApp;
  tg?.ready?.();
  tg?.expand?.();

  function getTgUser() {
    const u = tg?.initDataUnsafe?.user;
    if (u && u.id) {
      const obj = {
        id: u.id,
        username: u.username || "",
        first_name: u.first_name || "",
        last_name: u.last_name || ""
      };
      localStorage.setItem("tg_user", JSON.stringify(obj));
      return obj;
    }
    try {
      const cached = JSON.parse(localStorage.getItem("tg_user") || "null");
      if (cached && cached.id) return cached;
    } catch {}
    return { id: 999000, username: "browser_test", first_name: "Browser", last_name: "" };
  }

  // ================== STORAGE USERS ==================
  const USERS_KEY = "wh_users";

  function loadUsers() {
    try { return JSON.parse(localStorage.getItem(USERS_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveUsers(obj) {
    localStorage.setItem(USERS_KEY, JSON.stringify(obj));
  }

  function ensureUser(u) {
    const users = loadUsers();
    const id = String(u.id);

    if (!users[id]) {
      users[id] = {
        id: u.id,
        username: u.username || "",
        name: [u.first_name, u.last_name].filter(Boolean).join(" "),
        created_at: Date.now(),
        last_seen: Date.now(),
        launches: 0,
        total_active_ms: 0,
        win_chance: 1.0,
        generator_level: 0,

        // balances
        bal_mmcoin: 0,  // –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –∏–º—è –æ—Å—Ç–∞–≤–ª—è–µ–º, –≤ UI –ø–æ–∫–∞–∑—ã–≤–∞–µ–º MMMcoin
        bal_ton: 0,
        bal_usdt: 0,
        bal_stars: 0,

        wallet_linked: false
      };
    }

    users[id].username = u.username || users[id].username;
    users[id].name = [u.first_name, u.last_name].filter(Boolean).join(" ") || users[id].name;
    users[id].last_seen = Date.now();
    users[id].launches = (users[id].launches || 0) + 1;

    saveUsers(users);
    return users[id];
  }

  // ================== TIME IN APP ==================
  let sessionStart = null;

  function startSession() {
    if (sessionStart === null) sessionStart = Date.now();
  }

  function stopSessionAndAccumulate(userObj) {
    if (sessionStart === null) return;
    const delta = Date.now() - sessionStart;
    sessionStart = null;

    const users = loadUsers();
    const id = String(userObj.id);
    if (!users[id]) return;

    users[id].total_active_ms = Number(users[id].total_active_ms || 0) + Math.max(0, delta);
    users[id].last_seen = Date.now();
    saveUsers(users);
  }

  // ================== TICKER (–≤–µ—Ä–Ω—É–ª–∏) ==================
  function renderTicker() {
    // –ü–æ–∫–∞ —Ñ–µ–π–∫–æ–≤–∞—è –ª–µ–Ω—Ç–∞. –ü–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º –∫ —Å–µ—Ä–≤–µ—Ä—É/–ë–î.
    const feed = [
      "–°–∏—Å—Ç–µ–º–∞: —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω",
      "–ö—Ç–æ-—Ç–æ —É–ª—É—á—à–∏–ª –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–æ lvl 2",
      "–ù–∞–π–¥–µ–Ω–æ 20 USDT",
      "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª 0.5 TON"
    ];
    const el = document.getElementById("tickerContent");
    if (el) el.textContent = "üîî " + feed.join("   ‚Ä¢   ");
  }

  // ================== MMMcoin EMISSION ==================
  const MMM_TOTAL = 30000000.0; // 30 000 000.000

  function calcMMMEmission() {
    let used = 0.0;
    try {
      const users = loadUsers();
      for (const id in users) {
        used += Number(users[id].bal_mmcoin || 0);
      }
    } catch {}

    const left = Math.max(0, MMM_TOTAL - used);
    const percent = MMM_TOTAL <= 0 ? 0 : Math.min(100, (used / MMM_TOTAL) * 100);

    const usedEl = document.getElementById("mmmUsed");
    const leftEl = document.getElementById("mmmLeft");
    const barEl = document.getElementById("mmmBar");

    if (usedEl) usedEl.textContent = used.toFixed(3);
    if (leftEl) leftEl.textContent = left.toFixed(3);
    if (barEl) barEl.style.width = percent.toFixed(6) + "%";
  }

  // ================== RENDER UI ==================
  const tgUser = getTgUser();
  const userObj = ensureUser(tgUser);

  function render() {
    const title = tgUser.username ? `@${tgUser.username}` : (tgUser.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å");
    document.getElementById("uTitle").textContent = title;
    document.getElementById("uSub").textContent = `ID: ${tgUser.id}`;

    const ws = document.getElementById("walletStatus");
    if (userObj.wallet_linked) {
      ws.textContent = "–ö–æ—à–µ–ª—ë–∫: ‚úÖ –ø—Ä–∏–≤—è–∑–∞–Ω";
      ws.classList.remove("bad");
      ws.classList.add("ok");
    } else {
      ws.textContent = "–ö–æ—à–µ–ª—ë–∫: ‚ùå –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω";
      ws.classList.remove("ok");
      ws.classList.add("bad");
    }

    document.getElementById("launches").textContent = String(userObj.launches || 1);
    document.getElementById("winChance").textContent = String(Number(userObj.win_chance || 1.0).toFixed(1));
    document.getElementById("genLevel").textContent = String(userObj.generator_level || 0);

    document.getElementById("mmcoin").textContent = String(userObj.bal_mmcoin || 0);
    document.getElementById("ton").textContent = String(userObj.bal_ton || 0);
    document.getElementById("usdt").textContent = String(userObj.bal_usdt || 0);
    document.getElementById("stars").textContent = String(userObj.bal_stars || 0);

    const mins = Math.floor(Number(userObj.total_active_ms || 0) / 60000);
    document.getElementById("timeMin").textContent = String(mins);

    // ADMIN –∫–Ω–æ–ø–∫–∞ —Ç–æ–ª—å–∫–æ —Ç–µ–±–µ
    if (Number(tgUser.id) === Number(ADMIN_ID) && ADMIN_ID !== 0) {
      document.getElementById("adminBtn").style.display = "inline-block";
    } else {
      document.getElementById("adminBtn").style.display = "none";
    }

    // —ç–º–∏—Å—Å–∏—è
    calcMMMEmission();
  }

  // —Å—Ç–∞—Ä—Ç
  renderTicker();
  startSession();
  render();

  // –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  setInterval(() => {
    // –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –∞–¥–º–∏–Ω–∫–∞ –ø—Ä–∞–≤–∏–ª–∞ localStorage)
    const users = loadUsers();
    const refreshed = users[String(tgUser.id)];
    if (refreshed) Object.assign(userObj, refreshed);

    // –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º "—Å–µ—Å—Å–∏—é" –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é –º–∏–Ω—É—Ç
    if (sessionStart !== null) {
      const virtualTotal = Number(userObj.total_active_ms || 0) + (Date.now() - sessionStart);
      document.getElementById("timeMin").textContent = String(Math.floor(virtualTotal / 60000));
    }

    renderTicker();
    render();
  }, 10000);

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") {
      stopSessionAndAccumulate(userObj);
    } else {
      startSession();
      renderTicker();
      render();
    }
  });

  window.addEventListener("beforeunload", () => stopSessionAndAccumulate(userObj));
</script>
</body>
</html>
