<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>WalletHunter ‚Äî –ö–∞–±–∏–Ω–µ—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../css/main.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    .wrap{max-width:980px;margin:0 auto;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .card{border:1px solid #00ff99;border-radius:12px;padding:12px;text-align:left;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .muted{opacity:.75}
    .title{font-size:18px;font-weight:800;margin:0 0 6px 0;}
    .kv{display:flex;justify-content:space-between;border-bottom:1px dashed rgba(0,255,153,.25);padding:6px 0;}
    .kv:last-child{border-bottom:none;}
    .pill{padding:2px 8px;border:1px solid #00ff99;border-radius:999px;font-size:12px;}
    .ok{color:#00ff99}
    .bad{color:#ff6b6b;border-color:#ff6b6b}
    .btnWide{min-width:220px}
    .navBar{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px;background:rgba(11,11,11,.95);
      border-top:1px solid #00ff99;
      display:flex;gap:10px;justify-content:center;flex-wrap:wrap;
    }
    body{padding-bottom:90px;}
    /* –±–µ–≥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞ */
    .tickerWrap{border:1px solid #00ff99;border-radius:12px;overflow:hidden;}
    .ticker{white-space:nowrap;display:inline-block;padding:8px 0;}
    .tickerInner{display:inline-block;padding-left:100%;animation:scroll 18s linear infinite;}
    @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
    .adminBtn{border-color:#ffd166;color:#ffd166}
  </style>
</head>

<body>
<div class="wrap">
  <h2>üë§ –ö–∞–±–∏–Ω–µ—Ç</h2>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="title" id="uTitle">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
        <div class="muted" id="uSub">‚Äî</div>
      </div>

      <div class="row">
        <span class="pill" id="walletStatus">–ö–æ—à–µ–ª—ë–∫: ?</span>
        <button id="adminBtn" class="adminBtn" style="display:none;" onclick="location.href='admin.html'">
          üîß ADMIN
        </button>
      </div>
    </div>
  </div>

  <div class="tickerWrap" style="margin:12px 0;">
    <div class="ticker">
      <div class="tickerInner" id="tickerText">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π‚Ä¶</div>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="title">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å</div>
      <div class="kv"><span class="muted">–í—Ä–µ–º—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</span><span><b id="timeMin">0</b> –º–∏–Ω</span></div>
      <div class="kv"><span class="muted">–ó–∞–ø—É—Å–∫–æ–≤</span><span><b id="launches">1</b></span></div>
      <div class="kv"><span class="muted">–®–∞–Ω—Å –≤—ã–∏–≥—Ä—ã—à–∞</span><span><b id="winChance">1.0</b>%</span></div>
      <div class="kv"><span class="muted">–£—Ä–æ–≤–µ–Ω—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞</span><span><b id="genLevel">0</b></span></div>
    </div>

    <div class="card">
      <div class="title">üí∞ –ë–∞–ª–∞–Ω—Å—ã (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∏)</div>
      <div class="kv"><span class="muted">3MCoin</span><span><b id="mmcoin">0</b></span></div>
      <div class="kv"><span class="muted">TON</span><span><b id="ton">0</b></span></div>
      <div class="kv"><span class="muted">USDT</span><span><b id="usdt">0</b></span></div>
      <div class="kv"><span class="muted">Stars</span><span><b id="stars">0</b></span></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="title">üéÆ –ú–µ–Ω—é</div>
    <div class="row">
      <button class="btnWide" onclick="location.href='hunt.html'">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å</button>
      <button class="btnWide" onclick="location.href='mmcoin.html'">üí† 3MCoin</button>
      <button class="btnWide" onclick="location.href='leaderboard.html'">üèÜ –¢–æ–ø</button>
    </div>
    <div class="muted" style="margin-top:8px;">
      –°–µ–π—á–∞—Å –º—ã —Å—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ –∏ UX. –†–µ–∞–ª—å–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏/–≤—ã–ø–ª–∞—Ç—ã –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ.
    </div>
  </div>
</div>

<div class="navBar">
  <button onclick="location.href='dashboard.html'">–í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é</button>
  <button onclick="location.href='dashboard.html'">–í–æ–∑–≤—Ä–∞—Ç –≤ –∫–æ—à–µ–ª—ë–∫</button>
</div>

<script>
  // ========= –ù–ê–°–¢–†–û–ô–ö–ò =========
  // –ü–æ—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π Telegram ID (—á–∏—Å–ª–æ). –¢–æ–≥–¥–∞ –∫–Ω–æ–ø–∫–∞ ADMIN –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ —É —Ç–µ–±—è.
  const ADMIN_ID = 0; // <-- –í–ü–ò–®–ò –°–í–û–ô ID

  // ========= TELEGRAM USER =========
  const tg = window.Telegram?.WebApp;
  tg?.ready?.();

  function getTgUser() {
    // 1) –ø—Ä–æ–±—É–µ–º –∏–∑ Telegram WebApp
    const u = tg?.initDataUnsafe?.user;
    if (u && u.id) return {
      id: u.id,
      username: u.username || "",
      first_name: u.first_name || "",
      last_name: u.last_name || ""
    };

    // 2) –ø—Ä–æ–±—É–µ–º –∏–∑ localStorage, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∫–ª–∞–¥—ë—Ç app.js
    try {
      const cached = JSON.parse(localStorage.getItem("tg_user") || "null");
      if (cached && cached.id) return cached;
    } catch {}

    // 3) fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
    return { id: 999000, username: "browser_test", first_name: "Browser", last_name: "" };
  }

  // ========= STORAGE (—Ä–µ–µ—Å—Ç—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) =========
  const USERS_KEY = "wh_users"; // { [id]: userObj }

  function loadUsers() {
    try { return JSON.parse(localStorage.getItem(USERS_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveUsers(obj) {
    localStorage.setItem(USERS_KEY, JSON.stringify(obj));
  }

  function ensureUser(u) {
    const users = loadUsers();
    const id = String(u.id);

    if (!users[id]) {
      users[id] = {
        id: u.id,
        username: u.username || "",
        name: [u.first_name, u.last_name].filter(Boolean).join(" "),
        created_at: Date.now(),
        last_seen: Date.now(),
        launches: 0,

        // –ø—Ä–æ–≥—Ä–µ—Å—Å/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        total_active_ms: 0,
        win_chance: 1.0,
        generator_level: 0,

        // –±–∞–ª–∞–Ω—Å—ã (–∑–∞–≥–ª—É—à–∫–∏)
        bal_mmcoin: 0,
        bal_ton: 0,
        bal_usdt: 0,
        bal_stars: 0,

        // —Ç–∞–π–º–∏–Ω–≥–∏ –Ω–∞ –±—É–¥—É—â–µ–µ (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ, –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º)
        wallet_duration_hours: null,
        seed_duration_minutes: null,

        wallet_linked: false
      };
    }

    // –æ–±–Ω–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ
    users[id].username = u.username || users[id].username;
    users[id].name = [u.first_name, u.last_name].filter(Boolean).join(" ") || users[id].name;
    users[id].last_seen = Date.now();
    users[id].launches = (users[id].launches || 0) + 1;

    saveUsers(users);
    return users[id];
  }

  // ========= –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ =========
  // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–∏–¥–∏–º–∞.
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ total_active_ms –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
  let sessionStart = null;

  function startSession() {
    if (sessionStart === null) sessionStart = Date.now();
  }

  function stopSessionAndAccumulate(userObj) {
    if (sessionStart === null) return;
    const delta = Date.now() - sessionStart;
    sessionStart = null;

    const users = loadUsers();
    const id = String(userObj.id);
    if (!users[id]) return;

    users[id].total_active_ms = Number(users[id].total_active_ms || 0) + Math.max(0, delta);
    users[id].last_seen = Date.now();
    saveUsers(users);
  }

  function getTotalMinutes(userObj) {
    return Math.floor(Number(userObj.total_active_ms || 0) / 60000);
  }

  // ========= –õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π (–ø–æ–∫–∞ —Ñ–µ–π–∫–æ–≤–∞—è) =========
  const FEED_KEY = "wh_feed"; // –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫
  function seedFeedIfEmpty() {
    let feed = [];
    try { feed = JSON.parse(localStorage.getItem(FEED_KEY) || "[]"); } catch {}
    if (feed.length === 0) {
      feed = [
        "5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª 0.5 TON",
        "12 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥ –Ω–∞–π–¥–µ–Ω–æ 20 USDT",
        "1 —á–∞—Å –Ω–∞–∑–∞–¥ –∫—Ç–æ-—Ç–æ –∞–ø–Ω—É–ª –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–æ lvl 2",
        "–°–∏—Å—Ç–µ–º–∞: —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω"
      ];
      localStorage.setItem(FEED_KEY, JSON.stringify(feed));
    }
  }
  function renderFeed() {
    seedFeedIfEmpty();
    let feed = [];
    try { feed = JSON.parse(localStorage.getItem(FEED_KEY) || "[]"); } catch {}
    const text = feed.join("   ‚Ä¢   ");
    document.getElementById("tickerText").textContent = text || "–°–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç";
  }

  // ========= UI RENDER =========
  const tgUser = getTgUser();
  const userObj = ensureUser(tgUser);

  function render() {
    const title = tgUser.username ? `@${tgUser.username}` : (tgUser.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å");
    document.getElementById("uTitle").textContent = title;
    document.getElementById("uSub").textContent = `ID: ${tgUser.id}`;

    // –∫–æ—à–µ–ª—ë–∫ ‚Äî –ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞
    const ws = document.getElementById("walletStatus");
    if (userObj.wallet_linked) {
      ws.textContent = "–ö–æ—à–µ–ª—ë–∫: ‚úÖ –ø—Ä–∏–≤—è–∑–∞–Ω";
      ws.classList.remove("bad");
      ws.classList.add("ok");
    } else {
      ws.textContent = "–ö–æ—à–µ–ª—ë–∫: ‚ùå –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω";
      ws.classList.remove("ok");
      ws.classList.add("bad");
    }

    document.getElementById("launches").textContent = String(userObj.launches || 1);
    document.getElementById("winChance").textContent = String(Number(userObj.win_chance || 1.0).toFixed(1));
    document.getElementById("genLevel").textContent = String(userObj.generator_level || 0);

    document.getElementById("mmcoin").textContent = String(userObj.bal_mmcoin || 0);
    document.getElementById("ton").textContent = String(userObj.bal_ton || 0);
    document.getElementById("usdt").textContent = String(userObj.bal_usdt || 0);
    document.getElementById("stars").textContent = String(userObj.bal_stars || 0);

    document.getElementById("timeMin").textContent = String(getTotalMinutes(userObj));

    // admin button —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞
    if (Number(tgUser.id) === Number(ADMIN_ID) && ADMIN_ID !== 0) {
      document.getElementById("adminBtn").style.display = "inline-block";
    } else {
      document.getElementById("adminBtn").style.display = "none";
    }
  }

  // ========= LIFECYCLE =========
  renderFeed();
  render();

  // —Å—Ç–∞—Ä—Ç—É–µ–º –ø–æ–¥—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏
  startSession();

  // –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω—É—Ç–∫–∏ (–±–µ–∑ –ª–∏—à–Ω–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏)
  setInterval(() => {
    // –∞–∫–∫—É—Ä–∞—Ç–Ω–æ: –æ–±–Ω–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–º–æ–≥–ª–∞ –ø–æ–º–µ–Ω—è—Ç—å—Å—è –∞–¥–º–∏–Ω–∫–æ–π)
    const users = loadUsers();
    const cur = users[String(tgUser.id)];
    if (cur) {
      // –µ—Å–ª–∏ —Å–µ—Å—Å–∏—è –∏–¥—ë—Ç ‚Äî –ø—Ä–∏–±–∞–≤–∏–º "–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const total = Number(cur.total_active_ms || 0) + (sessionStart ? (Date.now() - sessionStart) : 0);
      document.getElementById("timeMin").textContent = String(Math.floor(total / 60000));

      document.getElementById("winChance").textContent = String(Number(cur.win_chance || 1.0).toFixed(1));
      document.getElementById("genLevel").textContent = String(cur.generator_level || 0);

      document.getElementById("mmcoin").textContent = String(cur.bal_mmcoin || 0);
      document.getElementById("ton").textContent = String(cur.bal_ton || 0);
      document.getElementById("usdt").textContent = String(cur.bal_usdt || 0);
      document.getElementById("stars").textContent = String(cur.bal_stars || 0);
    }
  }, 15000);

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") {
      stopSessionAndAccumulate(userObj);
    } else {
      startSession();
      // –Ω–∞ –≤—Ö–æ–¥–µ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º
      const users = loadUsers();
      const refreshed = users[String(tgUser.id)];
      if (refreshed) {
        Object.assign(userObj, refreshed);
      }
      render();
      renderFeed();
    }
  });

  window.addEventListener("beforeunload", () => {
    stopSessionAndAccumulate(userObj);
  });
</script>
</body>
</html>
